<!DOCTYPE html>
<html lang="fr">
{{template "InitPage" .}}
<body>
    {{template "ForumHeader" .}}

<div class="dashboard-header">
  <div class="topic-top">
    <h2>{{.Topic.Name}}</h2>
     {{if .CurrentUser.LogStatus}}<form action="/answermessage" method="GET">
          <input type="hidden" name="topic_id" value="{{.Topic.TopicID}}"> 
          <button type="submit" class="respond-btn">
           RÃ©pondre 
          </button>
        </form>{{end}}
  </div>
</div>

<main class="main-content">

    <aside class="sidebar">
        {{range .Topic.Messages}}
        â€¢ <a href="#{{.MessageID}}">Message du {{.Created}}</a> par {{.Author.Username}}
      <br>
      {{end}}
      </aside>

  <section class="posts-section">
            {{range $index, $message := .Topic.Messages}}
            <div class="post-card 
            {{if or (eq $.CurrentUser.UserType 1) (eq $.CurrentUser.UserType 2) (eq $.CurrentUser.ID $message.Author.ID)}} {{if eq $message.Warning 1}} warning {{end}} {{end}}"
             id="{{$message.MessageID}}" >
                <img class="post-avatar" src="{{$message.Author.ProfilPic}}"/>
                <div class="post-content">
                    <div class="post-title">{{$message.Author.Username}}</div>
                    <pre class="post-text">
{{$message.Content}}</pre>
                <div class="post-actions">
                            <form method="POST" action="/messageactions">
                                <input type="hidden" name="modname" value="{{$.CurrentUser.Username}}">
                                <input type="hidden" name="postID" value="{{$message.MessageID}}">
                                <input type="hidden" name="topicID" value="{{$.Topic.TopicID}}">
                               {{if eq $.CurrentUser.UserType 1}}  
                               {{if eq $message.Warning 1}} <button name="action" style="cursor:pointer;" type="submit" value="cancel" title="Annuler le signalement">ğŸ”•</button> {{end}}
                               {{if ne $index 0}}
                               <button class="cancelmove is-hidden" type="button" style="cursor:pointer;" onclick="CancelMove(this)">âœ–ï¸</button>
                               <select name="topicindex" class="topicindex is-hidden" title="Choisissez le sujet oÃ¹ placer le message">
                                <option value=""></option>
                                    {{range $.AllTopics}}
                                    <option value="{{.TopicID}}">{{.Name}}</option>
                                    {{end}}
                                </select>
                                <button name="action" style=" cursor:pointer;" type="submit" value ="move" class="movebutton" title="DÃ©placer le message" onclick="MoveMessage(this)">â†©ï¸</button>
                                
                            {{end}}
                               {{end}}
                               
                    {{if eq $.CurrentUser.UserType 2}} 
                    {{if eq $message.Warning 0}}
                    <button class="cancelwarn is-hidden" type="button" style="cursor:pointer;" onclick="CancelSignal(this)">âœ–ï¸</button>
                    <input type="text" name="warning" placeholder="Raison du signalement" class="warning-input is-hidden">
                    <button name="action" style="cursor:pointer;" type="submit" value="warn" title="Signaler le message" onclick="Signal(this)" class="warnbutton">âš ï¸</button> {{end}} 
                    {{end}}
                   
                               {{if or (eq $.CurrentUser.UserType 1) (eq $.CurrentUser.UserType 2) (eq $.CurrentUser.ID $message.Author.ID)}} 
                            

                               <button name="action" style=" cursor:pointer;" type="submit" value ="delete" title="Supprimer le message">ğŸ—‘ï¸</button>
                               <button name="action" style="cursor: pointer;" type="submit" value="edit" title="Modifier le message">ğŸ“</button> {{end}}
                            </form>
                </div>
                </div>

            {{if or (eq $.CurrentUser.UserType 1) (eq $.CurrentUser.UserType 2) (eq $.CurrentUser.ID $message.Author.ID)}}    
                {{if eq $message.Warning 1}} <span style="cursor:default" title="Ce message a Ã©tÃ© signalÃ© comme potentiellement problÃ©matique">â€¼ï¸</span>  {{end}}
            {{end}}
                {{if $.CurrentUser.LogStatus}}<div class="action-column">
                   <form method="POST" action="/like" class="like-form">
            <input type="hidden" name="postID" value="{{$message.MessageID}}">
            <button type="submit" class="action-btn">
                <span>ğŸ‘</span>
                <span>{{$message.Likes}}</span>
            </button>
                    </form>
                    <form method="POST" action="/dislike" class="like-form">
            <input type="hidden" name="postID" value="{{$message.MessageID}}">
            <button type="submit" class="action-btn">
                <span>ğŸ‘</span>
                <span>{{$message.Dislikes}}</span>
            </button>
                    </form>
                    
                </div>
                {{else }}
                <div>
                  <span>ğŸ‘</span>
                <span>{{$message.Likes}}</span>
                </div>
                <div> <span>ğŸ‘</span>
                <span>{{$message.Dislikes}}</span></div>
                {{end}}
            </div>
            {{end}}

        </section>
        </main>
    </div>

    {{template "ReponseBox"}}


   <style>.posts-section .post-card:first-child {
  /* border-bottom:10px solid var(--color-highlight); */
  border-left:7px solid var(--color-highlight);
  margin-bottom: 25px;
}</style>
     

    <script>       
    function Signal(warnbutton) {
        const form = warnbutton.closest('form');
        const warninginput = form.querySelector('.warning-input');
        const cancelwarn = form.querySelector('.cancelwarn');

        if (warninginput.classList.contains("is-hidden")) {
            warninginput.classList.remove("is-hidden");
            cancelwarn.classList.remove("is-hidden");
            warninginput.required = true;
            warnbutton.innerHTML = "âœ…";
        } else if (warnbutton.innerHTML.includes("âœ…")) {
            // Note: This block isn't strictly necessary for the intended form submission flow, 
            // as clicking a submit button usually sends the form. 
            // However, I've left it to match the logic of the original else if.
            warninginput.classList.add("is-hidden");
            cancelwarn.classList.add("is-hidden");
            warninginput.required = false;
        }
    }

    function CancelSignal(cancelwarn) {
        const form = cancelwarn.closest('form');
        const warninginput = form.querySelector('.warning-input');
        const warnbutton = form.querySelector('.warnbutton');

        warninginput.classList.add("is-hidden");
        cancelwarn.classList.add("is-hidden");
        warninginput.required = false;
        warninginput.value = ""
        warnbutton.innerHTML = "âš ï¸";
    }

    function MoveMessage(movebutton) {
        const form = movebutton.closest('form');
        const topicindex = form.querySelector('.topicindex');
        const cancelmove = form.querySelector('.cancelmove');

        if (topicindex.classList.contains("is-hidden")) {
            topicindex.classList.remove("is-hidden");
            cancelmove.classList.remove("is-hidden");
            topicindex.required = true;
            movebutton.innerHTML = "âœ…";
        } else if (movebutton.innerHTML.includes("âœ…")) {
            // See note in Signal() function above.
            topicindex.classList.add("is-hidden");
            cancelmove.classList.add("is-hidden");
            topicindex.required = false;
        }
    }

    function CancelMove(cancelmove) {
        const form = cancelmove.closest('form');
        const topicindex = form.querySelector('.topicindex');
        const movebutton = form.querySelector('.movebutton');

        topicindex.classList.add("is-hidden");
        cancelmove.classList.add("is-hidden");
        topicindex.value = ""
        topicindex.required = false;
        movebutton.innerHTML = "â†©ï¸";
    }

        // Animation au scroll
        window.addEventListener('scroll', () => {
            const posts = document.querySelectorAll('.post');
            posts.forEach(post => {
                const rect = post.getBoundingClientRect();
                if (rect.top < window.innerHeight && rect.bottom > 0) {
                    post.style.opacity = '1';
                    post.style.transform = 'translateY(0)';
                }
            });
        });

        // Recherche en temps rÃ©el (simulation)
        document.querySelector('.search-bar').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            const posts = document.querySelectorAll('.post');
            
            posts.forEach(post => {
                const content = post.querySelector('.post-content').textContent.toLowerCase();
                const username = post.querySelector('.username').textContent.toLowerCase();
                
                if (content.includes(query) || username.includes(query) || query === '') {
                    post.style.display = 'block';
                } else {
                    post.style.display = 'none';
                }
            });
        });

    </script>
</body>
</html>
