<!DOCTYPE html>
<html lang="fr">
{{template "InitPage" .}}
<body>
    {{template "ForumHeader" .}}

<div class="dashboard-header">
  <div class="topic-top">
    <h2><a href="/categorie/{{.Topic.CatID}}" style="text-decoration: none;"> {{.CatName}} </a> ‚û§ {{.Topic.Name}}</h2>
    {{if and .CurrentUser.LogStatus (ne .CurrentUser.UserType 4)}} <form action="/answermessage" method="GET">
          <input type="hidden" name="topic_id" value="{{.Topic.TopicID}}"> 
          <button type="submit" class="respond-btn">
           R√©pondre 
          </button>
        </form>{{end}}
  </div>
</div>

<main class="main-content">

    <aside class="sidebar">
        <h3>Naviguer sur le sujet</h3>
        {{range .Topic.Messages}}
     <div class="topic-index">   ‚Ä¢ <a href="#{{.MessageID}}">Message du {{.Created}}</a> par {{.Author.Username}}
      </div>
      {{end}}
      </aside>

  <section class="posts-section">
            {{range $index, $message := .Topic.Messages}}
            <form method="POST" action="/messageactions">
            <div class="post-card 
            {{if or (eq $.CurrentUser.UserType 1) (eq $.CurrentUser.UserType 2) (eq $.CurrentUser.ID $message.Author.ID)}} {{if eq $message.Warning 1}} warning {{end}} {{end}}"
             id="{{$message.MessageID}}" >
                <img class="post-avatar" src="{{$message.Author.ProfilPic}}"/>
                <div class="post-content">
                    <div class="post-title">{{$message.Author.Username}}</div>
                    <textarea name="message-content" class="edit-message is-hidden">{{$message.Content}}</textarea>
                    <div class="post-text">{{$message.Content}}</div>
                <div class="post-actions">
                            
                                <input type="hidden" name="modname" value="{{$.CurrentUser.Username}}">
                                <input type="hidden" name="postID" value="{{$message.MessageID}}">
                                <input type="hidden" name="topicID" value="{{$.Topic.TopicID}}">
                               {{if eq $.CurrentUser.UserType 1}}  
                               {{if eq $message.Warning 1}} <button class="action-btn" name="action" style="cursor:pointer;" type="submit" value="cancel" title="Annuler le signalement">üîï</button> {{end}}
                               {{if ne $index 0}}
                               <button class="cancelmove is-hidden action-btn" type="button" style="cursor:pointer;" title="Annuler le d√©placement" onclick="CancelMove(this)">‚úñÔ∏è</button>
                               <select name="topicindex" class="topicindex is-hidden post-input" title="Choisissez le sujet o√π placer le message">
                                <option value=""></option>
                                    {{range $.AllTopics}}
                                    {{if ne .TopicID $.Topic.TopicID}} <option value="{{.TopicID}}">{{.Name}} (ID : {{.TopicID}})</option> {{end}}
                                    {{end}}
                                </select>
                                <button name="action" style=" cursor:pointer;" type="submit" value ="move" class="movebutton action-btn" title="D√©placer le message" onclick="MoveMessage(this)">‚Ü©Ô∏è</button>
                                
                            {{end}}
                               {{end}}
                               
                    {{if eq $.CurrentUser.UserType 2}} 
                    {{if eq $message.Warning 0}}
                    <button class="cancelwarn is-hidden action-btn" type="button" style="cursor:pointer;" title="Annuler le signalement" onclick="CancelSignal(this)">‚úñÔ∏è</button>
                    <input type="text" name="warning" placeholder="Raison du signalement" class="warning-input is-hidden post-input">
                    <button name="action" style="cursor:pointer;" type="submit" value="warn" title="Signaler le message" onclick="Signal(this)" class="warnbutton action-btn">‚ö†Ô∏è</button> {{end}} 
                    {{end}}
                   
                               {{if or (eq $.CurrentUser.UserType 1) (eq $.CurrentUser.UserType 2) (eq $.CurrentUser.ID $message.Author.ID)}} 

                                <!-- Modal de confirmation pour la suppression -->
            <div class="modal modal-confirm is-hidden">
                <div class="modal-content">
                    <p>√ätes-vous s√ªr de vouloir supprimer ce message ? Cette action est irr√©versible.
                    </p>
                    <div class="modal-buttons">
                        <button class="modal-cancel-btn respond-btn">Annuler</button>
                        <button name="action" value="delete" type="submit" class="modal-confirm-btn respond-btn">Confirmer</button>
                    </div>
                </div>
            </div>

                    <button style="cursor:pointer;" class="delete-btn action-btn" type="button"  title="Supprimer le message">üöÆ</button>


                    
                    <button class="canceledit is-hidden action-btn" type="button" style="cursor:pointer;" title="Annuler les modifications" onclick="CancelEdit(this)">‚úñÔ∏è</button>
                    <button class="send-edit is-hidden action-btn" style="cursor: pointer;" name="action" type="submit" value="edit" onclick="MessageEdited(this)" title="Valider les modifications">‚úÖ</button>
                    <button name="action" style="cursor: pointer;" type="button" class="editbutton action-btn" onclick="EditMessage(this)" title="Modifier le message">üìù</button> {{end}}
                
            </div>
            </div></form>

            {{if or (eq $.CurrentUser.UserType 1) (eq $.CurrentUser.UserType 2) (eq $.CurrentUser.ID $message.Author.ID)}}    
                {{if eq $message.Warning 1}} <span style="cursor:default" title="Ce message a √©t√© signal√© comme potentiellement probl√©matique">‚ÄºÔ∏è</span>  {{end}}
            {{end}}
                {{if $.CurrentUser.LogStatus}}<div class="action-column">
                   <form method="POST" action="/like" class="like-form">
            <input type="hidden" name="postID" value="{{$message.MessageID}}">
            <button type="submit" class="action-btn" title="Ajouter un like">
                <span>üëç</span>
                <span>{{$message.Likes}}</span>
            </button>
                    </form>
                    <form method="POST" action="/dislike" class="like-form">
            <input type="hidden" name="postID" value="{{$message.MessageID}}">
            <button type="submit" class="action-btn" title="Ajouter un dislike">
                <span>üëé</span>
                <span>{{$message.Dislikes}}</span>
            </button>
                    </form>
                    
                </div>
                {{else }}
                <div>
                  <span>üëç</span>
                <span>{{$message.Likes}}</span>
                </div>
                <div> <span>üëé</span>
                <span>{{$message.Dislikes}}</span></div>
                {{end}}
            </div>
            {{end}}

        </section>
        </main>
    </div>



   <style>
   .posts-section form:first-child .post-card {
    border-left:7px solid var(--color-btnhover);
    margin-bottom: 25px;
    }
    .post-text {
    margin-bottom: 15px;
    }
    </style>
     

    <script>   
    // --- Local Modal Display/Hide Logic ---
document.querySelectorAll('.delete-btn').forEach(button => {
    button.addEventListener('click', (event) => {
        // Find the modal that is a direct sibling/child of the form's content
        const form = event.target.closest('form');
        const modal = form.querySelector('.modal'); // Use class selector since ID is duplicated
        
        if (modal) {
            form.classList.add('overall');
            modal.classList.remove('is-hidden');
            modal.style.display = 'flex';
        }
    });
});

document.querySelectorAll('.modal-cancel-btn').forEach(button => {
    button.addEventListener('click', (event) => {
        event.preventDefault();
        
        // Find the closest modal element
        const form = event.target.closest('form');
        const modal = event.target.closest('.modal');
        
        if (modal) {
            form.classList.remove('overall');
            modal.classList.add('is-hidden');
            modal.style.display = 'none';
        }
    });
});
     
    
    function EditMessage(editbutton) {
        const form = editbutton.closest('form');
        const editfield = form.querySelector('.edit-message');
        const canceledit = form.querySelector('.canceledit');
        const confirmedit = form.querySelector('.send-edit');
        const textmessage = form.querySelector('.post-text');

        if (editfield.classList.contains("is-hidden")) {
            editfield.classList.remove("is-hidden");
            canceledit.classList.remove("is-hidden");
            confirmedit.classList.remove("is-hidden");
            textmessage.classList.add("is-hidden");
            editbutton.classList.add("is-hidden");
        }
    }

    function CancelEdit(canceledit) {
        const form = canceledit.closest('form');
        const editfield = form.querySelector('.edit-message');
        const editbutton = form.querySelector('.editbutton');
        const confirmedit = form.querySelector('.send-edit');
        const textmessage = form.querySelector('.post-text');


        editfield.classList.add("is-hidden");
        canceledit.classList.add("is-hidden");
        confirmedit.classList.add("is-hidden");
        textmessage.classList.remove("is-hidden")
        editbutton.classList.remove("is-hidden");
    }

    function Signal(warnbutton) {
        const form = warnbutton.closest('form');
        const warninginput = form.querySelector('.warning-input');
        const cancelwarn = form.querySelector('.cancelwarn');

        if (warninginput.classList.contains("is-hidden")) {
            warninginput.classList.remove("is-hidden");
            cancelwarn.classList.remove("is-hidden");
            warninginput.required = true;
            warnbutton.innerHTML = "‚úÖ";
        }
    }

    function CancelSignal(cancelwarn) {
        const form = cancelwarn.closest('form');
        const warninginput = form.querySelector('.warning-input');
        const warnbutton = form.querySelector('.warnbutton');

        warninginput.classList.add("is-hidden");
        cancelwarn.classList.add("is-hidden");
        warninginput.required = false;
        warninginput.value = ""
        warnbutton.innerHTML = "‚ö†Ô∏è";
    }

    function MoveMessage(movebutton) {
        const form = movebutton.closest('form');
        const topicindex = form.querySelector('.topicindex');
        const cancelmove = form.querySelector('.cancelmove');

        if (topicindex.classList.contains("is-hidden")) {
            topicindex.classList.remove("is-hidden");
            cancelmove.classList.remove("is-hidden");
            topicindex.required = true;
            movebutton.innerHTML = "‚úÖ";
        }
    }

    function CancelMove(cancelmove) {
        const form = cancelmove.closest('form');
        const topicindex = form.querySelector('.topicindex');
        const movebutton = form.querySelector('.movebutton');

        topicindex.classList.add("is-hidden");
        cancelmove.classList.add("is-hidden");
        topicindex.value = ""
        topicindex.required = false;
        movebutton.innerHTML = "‚Ü©Ô∏è";
    }

        // Animation au scroll
        window.addEventListener('scroll', () => {
            const posts = document.querySelectorAll('.post');
            posts.forEach(post => {
                const rect = post.getBoundingClientRect();
                if (rect.top < window.innerHeight && rect.bottom > 0) {
                    post.style.opacity = '1';
                    post.style.transform = 'translateY(0)';
                }
            });
        });

        // Recherche en temps r√©el (simulation)
        document.querySelector('.search-bar').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            const posts = document.querySelectorAll('.post');
            
            posts.forEach(post => {
                const content = post.querySelector('.post-content').textContent.toLowerCase();
                const username = post.querySelector('.username').textContent.toLowerCase();
                
                if (content.includes(query) || username.includes(query) || query === '') {
                    post.style.display = 'block';
                } else {
                    post.style.display = 'none';
                }
            });
        });

    </script>
</body>
</html>
